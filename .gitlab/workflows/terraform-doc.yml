create-terraform-doc:
  stage: doc
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH'
      when: always
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: always
  image:
    name: quay.io/terraform-docs/terraform-docs:latest
    entrypoint: ['']
  variables:
    MODULE_PATH: modules/ecs-asg-cluster
    DOC_FILENAME: README.md
  script:
    - terraform-docs markdown table \
      --output-file=${DOC_FILENAME} \
      --output-mode=replace \
      --sort=true \
      --sort-by=required \
      --hide-empty=true \
      --sensitive=true \
      --read-comments=true \
      --escape=false \
      --indent=2 \
      ${MODULE_PATH}
  artifacts:
    paths:
      - README.md

upload-terraform-doc:
  stage: doc
  image: alpine:latest
  variables:
    DOC_FILENAME: README.md
    MODULE_PATH: modules/ecs-asg-cluster
  script:
    - apk add curl jq
    - >
      CONTENT=$(cat ${DOC_FILENAME} | base64 -w 0) &&
      curl --request PUT --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN"
      --header "Content-Type: application/json" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/repository/files/${MODULE_PATH}/${DOC_FILENAME}"
      --data "{\"branch\":\"$CI_DEFAULT_BRANCH\",\"encoding\":\"base64\",\"content\":\"$CONTENT\",\"commit_message\":\"Update ${DOC_FILENAME} for version $CI_COMMIT_TAG\"}"
  needs:
    - create-terraform-doc
    - artifacts: true
